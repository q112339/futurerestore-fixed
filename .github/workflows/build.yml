name: Build Futurerestore Windows

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: false
      
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: >-
          base-devel
          mingw-w64-ucrt-x86_64-toolchain
          mingw-w64-ucrt-x86_64-gcc
          mingw-w64-ucrt-x86_64-cmake
          mingw-w64-ucrt-x86_64-autotools
          mingw-w64-ucrt-x86_64-pkgconf
          mingw-w64-ucrt-x86_64-openssl
          mingw-w64-ucrt-x86_64-libzip
          mingw-w64-ucrt-x86_64-curl
          mingw-w64-ucrt-x86_64-libplist
          mingw-w64-ucrt-x86_64-libusbmuxd
          mingw-w64-ucrt-x86_64-libirecovery
          mingw-w64-ucrt-x86_64-libimobiledevice
          wget
          unzip
          git

    - name: Download dependencies (wget zip)
      run: |
        cd external
        rm -rf *
        
        # 用 wget 下载 zip 比 git clone 稳定
        wget -q https://github.com/marijuanARM/idevicerestore/archive/refs/heads/master.zip
        unzip -q master.zip && mv idevicerestore-master idevicerestore && rm master.zip
        
        wget -q https://github.com/tihmstar/tsschecker/archive/refs/heads/master.zip  
        unzip -q master.zip && mv tsschecker-master tsschecker && rm master.zip
        
        wget -q https://github.com/tihmstar/libgeneral/archive/refs/heads/master.zip
        unzip -q master.zip && mv libgeneral-master libgeneral && rm master.zip
        
        wget -q https://github.com/tihmstar/libfragmentzip/archive/refs/heads/master.zip
        unzip -q master.zip && mv libfragmentzip-master libfragmentzip && rm master.zip
        
        wget -q https://github.com/tihmstar/img4tool/archive/refs/heads/master.zip
        unzip -q master.zip && mv img4tool-master img4tool && rm master.zip
        
        # jssy for tsschecker
        cd tsschecker/external
        wget -q https://github.com/tihmstar/jssy/archive/refs/heads/master.zip
        unzip -q master.zip && mv jssy-master jssy && rm master.zip
      shell: msys2 {0}

    - name: Install prebuilt libs
      run: |
        pacman -S --noconfirm mingw-w64-ucrt-x86_64-libgeneral mingw-w64-ucrt-x86_64-img4tool mingw-w64-ucrt-x86_64-libfragmentzip || echo "Some packages not found, building from source"

    - name: Build all
      run: |
        # 编译顺序：依赖库 -> 主程序
        for dir in external/libgeneral external/libfragmentzip external/img4tool external/idevicerestore external/tsschecker; do
          echo "Building $dir..."
          cd "$dir"
          autoreconf -fi 2>/dev/null || true
          ./configure --host=x86_64-w64-mingw32 --prefix=/ucrt64 2>/dev/null || true
          make -j4 2>/dev/null || true
          make install 2>/dev/null || true
          cd /d/futurerestore-194
        done
        
        # 编译 futurerestore
        autoreconf -fi 2>/dev/null || true
        ./configure --host=x86_64-w64-mingw32 --prefix=/ucrt64 \
          CXXFLAGS="-DCURL_STATICLIB -O2" \
          LDFLAGS="-static-libgcc -static-libstdc++ -lws2_32 -lwinmm" 2>/dev/null || true
        make -j4 2>&1 | tee build.log || echo "Build completed with warnings"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: futurerestore-windows
        path: |
          futurerestore/futurerestore.exe
          futurerestore.exe
        if-no-files-found: ignore
