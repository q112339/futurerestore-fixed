name: Build Futurerestore Windows

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive
        
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: >-
          mingw-w64-ucrt-x86_64-gcc
          mingw-w64-ucrt-x86_64-cmake
          mingw-w64-ucrt-x86_64-autotools
          mingw-w64-ucrt-x86_64-pkgconf
          mingw-w64-ucrt-x86_64-openssl
          mingw-w64-ucrt-x86_64-libzip
          mingw-w64-ucrt-x86_64-curl
          mingw-w64-ucrt-x86_64-libplist
          mingw-w64-ucrt-x86_64-libusbmuxd
          mingw-w64-ucrt-x86_64-libirecovery
          mingw-w64-ucrt-x86_64-libimobiledevice
          git
          make
          automake
          libtool
          autoconf

    - name: Clone missing submodules manually
      run: |
        cd external
        # 确保所有子模块都下载了
        git clone --depth 1 https://github.com/tihmstar/libgeneral.git || true
        git clone --depth 1 https://github.com/tihmstar/libfragmentzip.git || true
        git clone --depth 1 https://github.com/tihmstar/img4tool.git || true
        cd tsschecker/external
        git clone --depth 1 https://github.com/tihmstar/jssy.git || true

    - name: Apply fixes (Download retry and 32-bit compatibility)
      run: |
        # 这里会自动应用你上传的修改文件
        echo "Fixes applied via uploaded files"

    - name: Build libgeneral
      run: |
        cd external/libgeneral
        autoreconf -fi
        ./configure --host=x86_64-w64-mingw32 --prefix=/ucrt64
        make -j4
        make install

    - name: Build libfragmentzip
      run: |
        cd external/libfragmentzip
        autoreconf -fi
        ./configure --host=x86_64-w64-mingw32 --prefix=/ucrt64 --without-libcurl
        make -j4
        make install

    - name: Build img4tool
      run: |
        cd external/img4tool
        autoreconf -fi
        ./configure --host=x86_64-w64-mingw32 --prefix=/ucrt64
        make -j4
        make install

    - name: Build idevicerestore
      run: |
        cd external/idevicerestore
        autoreconf -fi
        ./configure --host=x86_64-w64-mingw32 --prefix=/ucrt64
        make -j4
        make install

    - name: Build tsschecker
      run: |
        cd external/tsschecker
        autoreconf -fi
        ./configure --host=x86_64-w64-mingw32 --prefix=/ucrt64
        make -j4
        make install

    - name: Build futurerestore
      run: |
        autoreconf -fi
        ./configure --host=x86_64-w64-mingw32 --prefix=/ucrt64 \
          CXXFLAGS="-DCURL_STATICLIB -O2" \
          LDFLAGS="-static-libgcc -static-libstdc++"
        make -j4

    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: futurerestore-windows
        path: futurerestore/futurerestore.exe
        
    - name: Create Release
      if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: futurerestore/futurerestore.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
