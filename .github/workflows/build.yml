name: Build Futurerestore Windows

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: false  # 禁用自动子模块，手动克隆
      
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: >-
          base-devel
          mingw-w64-ucrt-x86_64-toolchain
          mingw-w64-ucrt-x86_64-gcc
          mingw-w64-ucrt-x86_64-cmake
          mingw-w64-ucrt-x86_64-autotools
          mingw-w64-ucrt-x86_64-pkgconf
          mingw-w64-ucrt-x86_64-openssl
          mingw-w64-ucrt-x86_64-libzip
          mingw-w64-ucrt-x86_64-curl
          mingw-w64-ucrt-x86_64-libplist
          mingw-w64-ucrt-x86_64-libusbmuxd
          mingw-w64-ucrt-x86_64-libirecovery
          mingw-w64-ucrt-x86_64-libimobiledevice
          git

    - name: Clone dependencies manually
      run: |
        cd external
        rm -rf idevicerestore tsschecker libgeneral libfragmentzip img4tool
        git clone --depth 1 https://github.com/marijuanARM/idevicerestore.git
        git clone --depth 1 https://github.com/tihmstar/tsschecker.git
        git clone --depth 1 https://github.com/tihmstar/libgeneral.git
        git clone --depth 1 https://github.com/tihmstar/libfragmentzip.git
        git clone --depth 1 https://github.com/tihmstar/img4tool.git
        
        # Clone tsschecker submodules manually
        cd tsschecker/external
        git clone --depth 1 https://github.com/tihmstar/jssy.git

    - name: Build libgeneral
      run: |
        cd external/libgeneral
        autoreconf -fi
        ./configure --host=x86_64-w64-mingw32 --prefix=/ucrt64
        make -j4
        make install

    - name: Build libfragmentzip
      run: |
        cd external/libfragmentzip
        autoreconf -fi
        ./configure --host=x86_64-w64-mingw32 --prefix=/ucrt64 --without-libcurl
        make -j4
        make install

    - name: Build img4tool
      run: |
        cd external/img4tool
        autoreconf -fi
        ./configure --host=x86_64-w64-mingw32 --prefix=/ucrt64
        make -j4
        make install

    - name: Build idevicerestore
      run: |
        cd external/idevicerestore
        autoreconf -fi
        ./configure --host=x86_64-w64-mingw32 --prefix=/ucrt64
        make -j4
        make install

    - name: Build tsschecker
      run: |
        cd external/tsschecker
        autoreconf -fi
        ./configure --host=x86_64-w64-mingw32 --prefix=/ucrt64
        make -j4
        make install

    - name: Build futurerestore
      run: |
        autoreconf -fi
        ./configure --host=x86_64-w64-mingw32 --prefix=/ucrt64 \
          CXXFLAGS="-DCURL_STATICLIB -O2" \
          LDFLAGS="-static-libgcc -static-libstdc++ -lws2_32 -lwinmm"
        make -j4

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      if: success()  # 只有成功时才上传
      with:
        name: futurerestore-windows
        path: futurerestore/futurerestore.exe
        if-no-files-found: warn
